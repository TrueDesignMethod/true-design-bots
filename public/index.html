<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>TRUE — Life Design</title>
  <style>
    :root{
      --bg: #fff7f3;           /* warm cream */
      --panel: #fff9f7;        /* soft panel */
      --muted: #6b5b50;        /* warm muted brown */
      --accent: #d9734a;       /* warm orange accent */
      --accent-2: #f2b880;     /* lighter warm accent */
      --round: 12px;
    }
    body { font-family: Inter, system-ui, -apple-system, 'Segoe UI', Roboto, Arial; margin: 0; background: var(--bg); color: #2c2a28; }
    .wrap { max-width: 920px; margin: 28px auto; padding: 20px; }
    header { display:flex; justify-content:space-between; align-items:center; gap:16px; }
    h1 { margin:0; font-size:20px; color: #2c2a28; }
    .stage-controls { display:flex; gap:8px; }
    .stage-btn { padding:8px 12px; border-radius:10px; background:linear-gradient(180deg,#fff6f2,#fff3ef); border:1px solid #f1d6c4; cursor:pointer; color:var(--muted); }
    .stage-btn.active { background: linear-gradient(180deg,#ffd9bf,#ffd0a8); border-color: #f6b587; box-shadow: 0 6px 22px rgba(217,115,74,0.12); color:#3a2f2a; }
    main { margin-top:18px; display:grid; grid-template-columns: 1fr 360px; gap:18px; }
    .chat-panel { background:var(--panel); border-radius:var(--round); padding:14px; min-height:520px; border:1px solid #f2e5dd; }
    .sidebar { background:var(--panel); border-radius:var(--round); padding:14px; border:1px solid #f2e5dd; height:520px; overflow:auto; }
    #messages { height:360px; overflow:auto; padding:8px; display:flex; flex-direction:column; gap:8px; }
    .bubble { max-width:78%; padding:10px 12px; border-radius:12px; line-height:1.35; }
    .bubble.bot { background:#fff3ee; align-self:flex-start; border:1px solid #f6d7c8; color:#3b2f2c; }
    .bubble.user { background:var(--accent); color:#fff; align-self:flex-end; }
    .meta { font-size:12px; color:var(--muted); margin-top:6px; }
    .input-area { display:flex; gap:8px; margin-top:10px; align-items:flex-end; flex-direction:column; }
    .input-row { display:flex; gap:8px; width:100%; align-items:flex-end; }
    textarea { width:100%; border-radius:10px; padding:10px; border:1px solid #f1d6c4; min-height:72px; resize:vertical; background:#fffaf7; color:#2c2a28; }
    button.primary { background:var(--accent); color:#fff; border:none; padding:10px 14px; border-radius:10px; cursor:pointer; box-shadow: 0 6px 20px rgba(217,115,74,0.12); }
    .options { display:flex; gap:8px; margin-top:8px; flex-wrap:wrap; }
    .option-btn { background:#fff; border:1px solid #f1d6c4; padding:8px 10px; border-radius:8px; cursor:pointer; color:#3b2f2c; }
    .loading { font-size:13px; color:var(--muted); }
    .small { font-size:13px; color:var(--muted); }
    .export-btn { display:block; margin-top:14px; border-radius:8px; padding:8px; border:1px dashed #f1d6c4; background:transparent; cursor:pointer; color:var(--muted); }
    a.download-link { display:inline-block; margin-top:8px; color:var(--accent-2); background:#fff6f2; padding:8px; border-radius:8px; border:1px solid #f1d6c4; text-decoration:none; }
    pre.snapshot { white-space:pre-wrap; font-family:inherit; color:var(--muted); }
    select#starter-select { width:100%; padding:10px; border-radius:8px; border:1px solid #f1d6c4; background:#fffaf7; color:#2c2a28; }
    .privacy { margin-top:10px; font-size:13px; }
    .privacy a { color:var(--accent); text-decoration:none; }
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <div>
        <h1>TRUE — Life Design AI</h1>
      </div>

      <div class="stage-controls" role="tablist" aria-label="Stages">
        <button class="stage-btn active" data-stage="Discovery">Discovery</button>
        <button class="stage-btn" data-stage="Planning">Planning</button>
        <button class="stage-btn" data-stage="Alignment">Alignment</button>
      </div>
    </header>

    <main>
      <section class="chat-panel" aria-live="polite">
        <div id="messages" aria-label="Conversation"></div>

        <!-- Startup prompt + dropdown selector -->
        <div style="margin-top:8px;">
          <div id="startup-prompt" class="meta">Select what you'd like to get started with here:</div>
          <select id="starter-select" aria-label="Select an action">
            <!-- options will be populated by JS -->
          </select>
        </div>

        <div class="input-area">
          <div class="input-row">
            <textarea id="user-input" placeholder="Type your reply or pick an option from the menu above..."></textarea>
            <div style="display:flex;flex-direction:column;gap:8px">
              <button id="send-btn" class="primary">Send</button>
              <button id="export-btn" class="export-btn">Export LifePrint</button>
            </div>
          </div>

          <!-- privacy policy link replaces the old tip -->
          <div class="privacy">
            <a href="https://example.com/privacy" target="_blank" rel="noopener noreferrer">Privacy Policy</a>
          </div>
        </div>
      </section>

      <aside class="sidebar">
        <div><strong>Stage Info</strong></div>
        <div id="stage-desc" style="margin-top:8px" class="small">
          TRUE Discovery: We'll explore what matters most — values, motivations, starting point, and goal seeds.
        </div>

        <hr style="margin:14px 0">

        <div><strong>Session Snapshot</strong></div>
        <pre id="snapshot" class="snapshot" style="margin-top:8px">No data yet.</pre>

        <hr style="margin:14px 0">

        <div><strong>Quick actions</strong></div>
        <div style="margin-top:8px">
          <button class="option-btn" id="restart-btn">Start Over</button>
          <button class="option-btn" id="summary-btn">Get Discovery Summary (export)</button>
        </div>
      </aside>
    </main>
  </div>

  <script type="module">
    import { fetchOptions, expandOption, sendFull } from "./send.js";

    // State
    let currentStage = "Discovery";
    let conversation = []; // array of {role, content}
    const messagesEl = document.getElementById("messages");
    const userInput = document.getElementById("user-input");
    const sendBtn = document.getElementById("send-btn");
    const exportBtn = document.getElementById("export-btn");
    const snapshotEl = document.getElementById("snapshot");
    const stageDesc = document.getElementById("stage-desc");
    const starterSelect = document.getElementById("starter-select");

    // Curated options used both for dropdown and immediate UI
    function curatedOptions() {
      return {
        "Discovery": [
          { id: "d-1", label: "Help me discover my values", payload: "discover:values" },
          { id: "d-2", label: "Explore motivations that drive me", payload: "discover:motivations" },
          { id: "d-3", label: "Uncover my strengths and weaknesses", payload: "discover:advantages_disadvantages" },
          { id: "d-4", label: "Help me figure out 1-3 goals this month", payload: "discover:goal_seeds" },
          { id: "d-5", label: "Identify potential obstacles or fears to my goals", payload: "discover:obstacles" },
          { id: "d-6", label: "Identify what strengths or resources I already have", payload: "discover:strengths" },
          { id: "d-7", label: "Explore the new story I want to create for myself", payload: "discover:updated_story" },
          { id: "d-8", label: "Provide my starting point snapshot", payload: "discover:starting_snapshot" }
        ],
        "Planning": [
          { id: "p-1", label: "Discover 1-3 goals I want to prioritize this month", payload: "planning:prioritize_goals" },
          { id: "p-2", label: "Help me refine my goal: Clear goal statement, emotional anchor, desired outcome", payload: "planning:refine_goal" },
          { id: "p-3", label: "Provide one microstep, one momentum step, and one supporting habit", payload: "planning:micro_steps" },
          { id: "p-4", label: "Help me uncover which obstacles apply to this goal", payload: "planning:obstacle_map" },
          { id: "p-5", label: "Develop a 7-day action plan: 3 actions, 1 habit, 1 obstacle strategy, 1 reflection question", payload: "planning:7day" },
          { id: "p-6", label: "Develop a 30-day action plan: Momentum steps, Habit progression, Two checkpoint reflections", payload: "planning:30day" },
          { id: "p-7", label: "Develop a 90-day action plan: Monthly milestones, risk preparation, systems for discipline", payload: "planning:90day" }
        ],
        "Alignment": [
          { id: "a-1", label: "Help me identify my clutter: mental, emotional, physical, schedule", payload: "alignment:clutter" },
          { id: "a-2", label: "Identify which clutter I am ready to reduce, remove, or delegate", payload: "alignment:release_plan" },
          { id: "a-3", label: "Design how I will revise my goals when needed", payload: "alignment:revision_strategy" },
          { id: "a-4", label: "Identify what is helping me grow", payload: "alignment:growth_map" },
          { id: "a-5", label: "Give me a 90-day growth theme", payload: "alignment:90day_theme" },
          { id: "a-6", label: "Help me build a resilience toolkit", payload: "alignment:resilience" },
          { id: "a-7", label: "Give me nurture rituals based on energy, values, personality", payload: "alignment:nurture_rituals" },
          { id: "a-8", label: "Create an iteration strategy map for me", payload: "alignment:iteration_map" }
        ]
      };
    }

    // UI helpers
    function appendBubble(text, who = "bot") {
      const d = document.createElement("div");
      d.className = "bubble " + (who === "bot" ? "bot" : "user");
      d.textContent = text;
      messagesEl.appendChild(d);
      messagesEl.scrollTop = messagesEl.scrollHeight;
    }

    function clearOptionsArea() {
      const existing = document.querySelectorAll(".option-row");
      existing.forEach(e => e.remove());
    }

    function addOptionsToArea(options) {
      clearOptionsArea();
      if (!options || !options.length) return;
      const container = document.createElement("div");
      container.className = "option-row options";
      options.forEach(opt => {
        const btn = document.createEle
