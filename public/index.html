<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>TRUE — Life Design</title>
  <style>
    :root{
      --bg: #fff7f3;           /* warm cream */
      --panel: #fff9f7;        /* soft panel */
      --muted: #6b5b50;        /* warm muted brown */
      --accent: #d9734a;       /* warm orange accent */
      --accent-2: #f2b880;     /* lighter warm accent */
      --round: 12px;
    }
    body { font-family: Inter, system-ui, -apple-system, 'Segoe UI', Roboto, Arial; margin: 0; background: var(--bg); color: #2c2a28; }
    .wrap { max-width: 920px; margin: 28px auto; padding: 20px; }
    header { display:flex; justify-content:space-between; align-items:center; gap:16px; }
    h1 { margin:0; font-size:20px; color: #2c2a28; }
    .stage-controls { display:flex; gap:8px; }
    .stage-btn { padding:8px 12px; border-radius:10px; background:linear-gradient(180deg,#fff6f2,#fff3ef); border:1px solid #f1d6c4; cursor:pointer; color:var(--muted); }
    .stage-btn.active { background: linear-gradient(180deg,#ffd9bf,#ffd0a8); border-color: #f6b587; box-shadow: 0 6px 22px rgba(217,115,74,0.12); color:#3a2f2a; }
    main { margin-top:18px; display:grid; grid-template-columns: 1fr 360px; gap:18px; }
    .chat-panel { background:var(--panel); border-radius:var(--round); padding:14px; min-height:520px; border:1px solid #f2e5dd; }
    .sidebar { background:var(--panel); border-radius:var(--round); padding:14px; border:1px solid #f2e5dd; height:520px; overflow:auto; }
    #messages { height:360px; overflow:auto; padding:8px; display:flex; flex-direction:column; gap:8px; }
    .bubble { max-width:78%; padding:10px 12px; border-radius:12px; line-height:1.35; }
    .bubble.bot { background:#fff3ee; align-self:flex-start; border:1px solid #f6d7c8; color:#3b2f2c; }
    .bubble.user { background:var(--accent); color:#fff; align-self:flex-end; }
    .meta { font-size:12px; color:var(--muted); margin-top:6px; }
    .input-area { display:flex; gap:8px; margin-top:10px; align-items:flex-end; flex-direction:column; }
    .input-row { display:flex; gap:8px; width:100%; align-items:flex-end; }
    textarea { width:100%; border-radius:10px; padding:10px; border:1px solid #f1d6c4; min-height:72px; resize:vertical; background:#fffaf7; color:#2c2a28; }
    button.primary { background:var(--accent); color:#fff; border:none; padding:10px 14px; border-radius:10px; cursor:pointer; box-shadow: 0 6px 20px rgba(217,115,74,0.12); }
    .options { display:flex; gap:8px; margin-top:8px; flex-wrap:wrap; }
    .option-btn { background:#fff; border:1px solid #f1d6c4; padding:8px 10px; border-radius:8px; cursor:pointer; color:#3b2f2c; }
    .loading { font-size:13px; color:var(--muted); }
    .small { font-size:13px; color:var(--muted); }
    .export-btn { display:block; margin-top:14px; border-radius:8px; padding:8px; border:1px dashed #f1d6c4; background:transparent; cursor:pointer; color:var(--muted); }
    a.download-link { display:inline-block; margin-top:8px; color:var(--accent-2); background:#fff6f2; padding:8px; border-radius:8px; border:1px solid #f1d6c4; text-decoration:none; }
    pre.snapshot { white-space:pre-wrap; font-family:inherit; color:var(--muted); }
    select#starter-select { width:100%; padding:10px; border-radius:8px; border:1px solid #f1d6c4; background:#fffaf7; color:#2c2a28; }
    .privacy { margin-top:10px; font-size:13px; }
    .privacy a { color:var(--accent); text-decoration:none; }
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <div>
        <h1>TRUE — Life Design AI</h1>
      </div>
      <div class="stage-controls" role="tablist" aria-label="Stages">
        <button class="stage-btn active" data-stage="Discovery">Discovery</button>
        <button class="stage-btn" data-stage="Planning">Planning</button>
        <button class="stage-btn" data-stage="Alignment">Alignment</button>
      </div>
    </header>

    <main>
      <section class="chat-panel" aria-live="polite">
        <div id="messages" aria-label="Conversation"></div>

        <!-- Startup prompt + dropdown selector (options only here) -->
        <div style="margin-top:8px;">
          <div id="startup-prompt" class="meta">Let's explore what matters most to you. Select one of the options below to get started:</div>
          <select id="starter-select" aria-label="Select an action">
            <!-- populated by JS -->
          </select>
        </div>

        <div class="input-area">
          <div class="input-row">
            <textarea id="user-input" placeholder="Type your reply or pick an option from the menu above..."></textarea>
            <div style="display:flex;flex-direction:column;gap:8px">
              <button id="send-btn" class="primary">Send</button>
              <button id="export-btn" class="export-btn">Export LifePrint</button>
            </div>
          </div>

          <div class="privacy">
            <a href="https://example.com/privacy" target="_blank" rel="noopener noreferrer">Privacy Policy</a>
          </div>
        </div>
      </section>

      <aside class="sidebar">
        <div><strong>Stage Info</strong></div>
        <div id="stage-desc" style="margin-top:8px" class="small">
          TRUE Discovery: We'll explore what matters most — values, motivations, starting point, and goal seeds.
        </div>

        <hr style="margin:14px 0">

        <div><strong>Session Snapshot</strong></div>
        <pre id="snapshot" class="snapshot" style="margin-top:8px">No data yet.</pre>

        <hr style="margin:14px 0">

        <div><strong>Quick actions</strong></div>
        <div style="margin-top:8px">
          <button class="option-btn" id="restart-btn">Start Over</button>
          <button class="option-btn" id="summary-btn">Get Discovery Summary (export)</button>
        </div>
      </aside>
    </main>
  </div>

  <script type="module">
    import { fetchOptions, expandOption, sendFull } from "./send.js";

    // State
    let currentStage = "Discovery";
    let conversation = []; // array of {role, content}
    const messagesEl = document.getElementById("messages");
    const userInput = document.getElementById("user-input");
    const sendBtn = document.getElementById("send-btn");
    const exportBtn = document.getElementById("export-btn");
    const snapshotEl = document.getElementById("snapshot");
    const stageDesc = document.getElementById("stage-desc");
    const starterSelect = document.getElementById("starter-select");

    // Curated options (used to populate dropdown and as fallback)
    function curatedOptions() {
      return {
        "Discovery": [
          { id: "d-1", label: "Help me discover my values", payload: "discover:values" },
          { id: "d-2", label: "Explore motivations that drive me", payload: "discover:motivations" },
          { id: "d-3", label: "Uncover my strengths and weaknesses", payload: "discover:advantages_disadvantages" },
          { id: "d-4", label: "Help me figure out 1-3 goals this month", payload: "discover:goal_seeds" },
          { id: "d-5", label: "Identify potential obstacles or fears to my goals", payload: "discover:obstacles" },
          { id: "d-6", label: "Identify what strengths or resources I already have", payload: "discover:strengths" },
          { id: "d-7", label: "Explore the new story I want to create for myself", payload: "discover:updated_story" },
          { id: "d-8", label: "Provide my starting point snapshot", payload: "discover:starting_snapshot" }
        ],
        "Planning": [
          { id: "p-1", label: "Discover 1-3 goals I want to prioritize this month", payload: "planning:prioritize_goals" },
          { id: "p-2", label: "Help me refine my goal: Clear goal statement, emotional anchor, desired outcome", payload: "planning:refine_goal" },
          { id: "p-3", label: "Provide one microstep, one momentum step, and one supporting habit", payload: "planning:micro_steps" },
          { id: "p-4", label: "Help me uncover which obstacles apply to this goal", payload: "planning:obstacle_map" },
          { id: "p-5", label: "Develop a 7-day action plan: 3 actions, 1 habit, 1 obstacle strategy, 1 reflection question", payload: "planning:7day" },
          { id: "p-6", label: "Develop a 30-day action plan: Momentum steps, Habit progression, Two checkpoint reflections", payload: "planning:30day" },
          { id: "p-7", label: "Develop a 90-day action plan: Monthly milestones, risk preparation, systems for discipline", payload: "planning:90day" }
        ],
        "Alignment": [
          { id: "a-1", label: "Help me identify my clutter: mental, emotional, physical, schedule", payload: "alignment:clutter" },
          { id: "a-2", label: "Identify which clutter I am ready to reduce, remove, or delegate", payload: "alignment:release_plan" },
          { id: "a-3", label: "Design how I will revise my goals when needed", payload: "alignment:revision_strategy" },
          { id: "a-4", label: "Identify what is helping me grow", payload: "alignment:growth_map" },
          { id: "a-5", label: "Give me a 90-day growth theme", payload: "alignment:90day_theme" },
          { id: "a-6", label: "Help me build a resilience toolkit", payload: "alignment:resilience" },
          { id: "a-7", label: "Give me nurture rituals based on energy, values, personality", payload: "alignment:nurture_rituals" },
          { id: "a-8", label: "Create an iteration strategy map for me", payload: "alignment:iteration_map" }
        ]
      };
    }

    // UI helpers for message bubbles
    function appendBubble(text, who = "bot") {
      const d = document.createElement("div");
      d.className = "bubble " + (who === "bot" ? "bot" : "user");
      d.textContent = text;
      messagesEl.appendChild(d);
      messagesEl.scrollTop = messagesEl.scrollHeight;
    }
    function addBotMessage(text) {
      appendBubble(text, "bot");
      conversation.push({ role: "assistant", content: text });
    }
    function addUserMessage(text) {
      appendBubble(text, "user");
      conversation.push({ role: "user", content: text });
    }

    // Populate dropdown with a list of options (array of {id,label,payload})
    function setDropdownOptions(list) {
      starterSelect.innerHTML = "";
      const placeholder = document.createElement("option");
      placeholder.value = "";
      placeholder.textContent = `Choose an action (${currentStage})...`;
      placeholder.disabled = true;
      placeholder.selected = true;
      starterSelect.appendChild(placeholder);
      (list || []).forEach(opt => {
        const o = document.createElement("option");
        o.value = opt.payload;
        o.textContent = opt.label;
        o.dataset.optId = opt.id || "";
        starterSelect.appendChild(o);
      });
    }

    // When dropdown is used
    starterSelect.addEventListener("change", async (e) => {
      const payload = e.target.value;
      const optId = e.target.selectedOptions?.[0]?.dataset?.optId || "";
      const list = (curatedOptions()[currentStage] || curatedOptions().Discovery);
      const found = list.find(it => it.payload === payload) || { label: e.target.selectedOptions[0].textContent, payload, id: optId };
      // add user bubble for the chosen label
      addUserMessage(found.label);
      // route selection
      await handleOptionSelect(found);
      // reset select
      setTimeout(() => { starterSelect.selectedIndex = 0; }, 250);
    });

    // Core option selection handler
    async function handleOptionSelect(opt) {
      // Discovery scripted flows: ask client-side follow-up questions and populate dropdown for next steps
      if (opt.payload && opt.payload.startsWith("discover:")) {
        switch (opt.payload) {
          case "discover:values":
            // Ask the follow-up as a bot message (user sees the question)
            addBotMessage("Great — let's find your core values. Tell me one area of life that feels important to you right now (career, wellness, relationships, creativity, or something else).");
            setDropdownOptions([
              { id: "v-career", label: "Career", payload: "discover:value_area:career" },
              { id: "v-well", label: "Wellness", payload: "discover:value_area:wellness" },
              { id: "v-relationships", label: "Relationships", payload: "discover:value_area:relationships" },
              { id: "v-creativity", label: "Creativity", payload: "discover:value_area:creativity" },
              { id: "v-other", label: "Other — I'll type it", payload: "discover:value_area:other" }
            ]);
            return;
          case "discover:motivations":
            addBotMessage("What energizes you most these days? What gives you a sense of purpose or momentum?");
            setDropdownOptions([
              { id: "m-1", label: "Connection & relationships", payload: "discover:motivation:connection" },
              { id: "m-2", label: "Career growth & challenge", payload: "discover:motivation:career" },
              { id: "m-3", label: "Health & energy", payload: "discover:motivation:health" },
              { id: "m-4", label: "I'll type my own", payload: "discover:motivation:other" }
            ]);
            return;
          case "discover:advantages_disadvantages":
            addBotMessage("Let's map strengths and challenges. What skills, supports, or resources help you? (then we'll ask about obstacles)");
            setDropdownOptions([
              { id: "s-1", label: "Skills & knowledge", payload: "discover:strength:skills" },
              { id: "s-2", label: "People & relationships", payload: "discover:strength:people" },
              { id: "s-3", label: "Time & routines", payload: "discover:strength:routines" },
              { id: "s-4", label: "I'll describe my own", payload: "discover:strength:other" }
            ]);
            return;
          case "discover:goal_seeds":
            addBotMessage("What would you love to improve or move toward in the next chapter of your life? Try listing 1–3 short aspirations (examples: 'feel healthier', 'shift career').");
            setDropdownOptions([
              { id: "g-1", label: "I want to feel healthier", payload: "discover:goal:health" },
              { id: "g-2", label: "I want a career shift", payload: "discover:goal:career" },
              { id: "g-3", label: "I want stronger boundaries", payload: "discover:goal:boundaries" },
              { id: "g-4", label: "I'll type my own", payload: "discover:goal:other" }
            ]);
            return;
          case "discover:obstacles":
            addBotMessage("What tends to get in your way? List obstacles, fears, or limitations (time, confidence, resources, support).");
            setDropdownOptions([
              { id: "o-1", label: "Time & scheduling", payload: "discover:obstacle:time" },
              { id: "o-2", label: "Confidence & motivation", payload: "discover:obstacle:motivation" },
              { id: "o-3", label: "Resources & money", payload: "discover:obstacle:resources" },
              { id: "o-4", label: "Other — I'll type", payload: "discover:obstacle:other" }
            ]);
            return;
          case "discover:strengths":
            addBotMessage("Tell me about strengths, resources, people, or routines that support you.");
            setDropdownOptions([
              { id: "str-1", label: "Supportive people", payload: "discover:strengths:people" },
              { id: "str-2", label: "Skills & training", payload: "discover:strengths:skills" },
              { id: "str-3", label: "Stable routines/habits", payload: "discover:strengths:routines" },
              { id: "str-4", label: "I'll type my own", payload: "discover:strengths:other" }
            ]);
            return;
          case "discover:updated_story":
            addBotMessage("If there's one belief or story that no longer fits who you're becoming, what is it? Or: what new story would you like to try on?");
            setDropdownOptions([
              { id: "st-1", label: "I'm not enough → I'm learning & growing", payload: "discover:story:example1" },
              { id: "st-2", label: "I don't deserve rest → I prioritize renewal", payload: "discover:story:example2" },
              { id: "st-3", label: "I'll type my own", payload: "discover:story:other" }
            ]);
            return;
          case "discover:starting_snapshot":
            addBotMessage("Quick snapshot: On a scale of 1–10, how aligned do you feel in each area? (We'll ask a few areas). First: Career (1–10).");
            setDropdownOptions([
              { id: "snap-1", label: "1–3 (low)", payload: "discover:snapshot:career_low" },
              { id: "snap-2", label: "4–7 (somewhat)", payload: "discover:snapshot:career_mid" },
              { id: "snap-3", label: "8–10 (high)", payload: "discover:snapshot:career_high" },
              { id: "snap-4", label: "I'll type a number", payload: "discover:snapshot:career_custom" }
            ]);
            return;
          default:
            addBotMessage("Thanks — tell me more (or choose another area).");
            setDropdownOptions(curatedOptions()[currentStage] || curatedOptions().Discovery);
            return;
        }
      }

      // Planning/Alignment -> server expand (use expand to generate a helpful reply)
      if (opt.payload && (opt.payload.startsWith("planning:") || opt.payload.startsWith("alignment:"))) {
        addBotMessage("Working on that — one moment...");
        try {
          const res = await expandOption(currentStage, conversation, `expand:${opt.id}`);
          // remove the "Working..." bubble and replace with server reply
          messagesEl.lastChild?.remove();
          addBotMessage(res.reply || "No reply from server");
          conversation.push({ role: "user", content: opt.label });
          conversation.push({ role: "assistant", content: res.reply || "" });
          // if followUps provided by server, set them in dropdown
          if (res.followUps && Array.isArray(res.followUps) && res.followUps.length) {
            const fuList = res.followUps.map((f, i) => ({ id: `fu-${i}`, label: f, payload: `expand:fu-${i}` }));
            setDropdownOptions(fuList);
          } else {
            setDropdownOptions(curatedOptions()[currentStage] || curatedOptions().Discovery);
          }
          updateSnapshot(res);
        } catch (err) {
          messagesEl.lastChild?.remove();
          addBotMessage("Sorry — couldn't get details from server.");
          console.error(err);
        }
        return;
      }

      // If it's a follow-up payload like discover:motivation:career, and it's an "other" prompt, ask user to type
      if (opt.payload && opt.payload.includes("discover:") && opt.payload.endsWith(":other")) {
        addBotMessage("Please type your response in the box and click Send.");
        setDropdownOptions([]); // empty dropdown until they type
        return;
      }

      // Default fallback: ask server for next options (and populate dropdown)
      try {
        const resp = await fetchOptions(currentStage, conversation.concat([{ role: "user", content: opt.label }]));
        if (resp && resp.options) {
          const list = resp.options.map(o => ({ id: o.id || "", label: o.label, payload: o.payload || "" }));
          setDropdownOptions(list);
        } else {
          setDropdownOptions(curatedOptions()[currentStage] || curatedOptions().Discovery);
        }
      } catch (err) {
        console.error(err);
        setDropdownOptions(curatedOptions()[currentStage] || curatedOptions().Discovery);
      }
    }

    // requestOptions: populate dropdown (no initial bot message)
    async function requestOptions() {
      try {
        const curated = curatedOptions();
        setDropdownOptions(curated[currentStage] || curated["Discovery"]);

        // background fetch server options (replace dropdown if returns and user hasn't acted)
        try {
          const resp = await fetchOptions(currentStage, conversation);
          const userActions = conversation.filter(m => m.role === 'user').length;
          if (resp && resp.options && userActions === 0) {
            const list = resp.options.map(o => ({ id: o.id || "", label: o.label, payload: o.payload || "" }));
            setDropdownOptions(list);
            updateSnapshot(resp);
          }
        } catch (err) {
          console.warn("Server options not available; using curated options.");
        }
      } catch (err) {
        console.error("requestOptions error:", err);
      }
    }

    // Send typed free-text (full generation)
    sendBtn.addEventListener("click", async () => {
      const text = userInput.value.trim();
      if (!text) return;
      addUserMessage(text);
      userInput.value = "";
      try {
        addBotMessage("Generating a full response...");
        const res = await sendFull(currentStage, conversation.concat([{ role: "user", content: text }]));
        // remove the 'Generating...' bubble and show result
        messagesEl.lastChild?.remove();
        addBotMessage(res.reply || "No reply from server.");
        conversation.push({ role: "user", content: text });
        conversation.push({ role: "assistant", content: res.reply || "" });
        updateSnapshot(res);
        // reset dropdown to curated stage list
        setDropdownOptions(curatedOptions()[currentStage] || curatedOptions().Discovery);
      } catch (err) {
        console.error(err);
        addBotMessage("Error generating response: " + err.message);
      }
    });

    // Export LifePrint
    exportBtn.addEventListener("click", async () => {
      addBotMessage("Compiling your LifePrint summary — this may take a moment.");
      try {
        const messages = conversation.concat([{ role: "user", content: `Please compile a ${currentStage} summary / export for my LifePrint.` }]);
        const res = await sendFull("Export", messages);
        addBotMessage("LifePrint ready. Click the link below to download.");
        const blob = new Blob([res.reply], { type: "application/json" });
        const url = URL.createObjectURL(blob);
        const a = document.createElement("a");
        a.href = url;
        a.download = `TrueLifePrint-${currentStage}-${new Date().toISOString().slice(0,10)}.json`;
        a.textContent = `Download LifePrint (${currentStage})`;
        a.className = "download-link";
        messagesEl.appendChild(a);
        messagesEl.scrollTop = messagesEl.scrollHeight;
      } catch (err) {
        console.error(err);
        addBotMessage("Failed to compile LifePrint: " + err.message);
      }
    });

    // Stage buttons
    document.querySelectorAll(".stage-btn").forEach(btn => {
      btn.addEventListener("click", () => {
        setStage(btn.dataset.stage);
      });
    });

    // Quick actions
    document.getElementById("restart-btn").addEventListener("click", () => {
      conversation = [];
      messagesEl.innerHTML = "";
      userInput.value = "";
      // refresh dropdown (no startup bubble)
      requestOptions();
    });
    document.getElementById("summary-btn").addEventListener("click", () => {
      exportBtn.click();
    });

    // setStage definition (no startup bubble)
    function setStage(stage) {
      currentStage = stage;
      document.querySelectorAll(".stage-btn").forEach(b => b.classList.toggle("active", b.dataset.stage === stage));
      stageDesc.textContent = {
        "Discovery": "TRUE Discovery: We'll explore what matters most — values, motivations, starting point, and goal seeds.",
        "Planning": "TRUE Planning: We'll turn insights into clear, sustainable plans (7/14/30/90 day blueprints).",
        "Alignment": "TRUE Alignment: We'll create systems to maintain progress — simplification, growth, resilience, rituals."
      }[stage] || "";
      // Do not add a startup bot bubble; just refresh dropdown
      requestOptions();
    }

    // Initial setup: populate dropdown and do not create initial message bubble
    requestOptions();

  </script>
</body>
</html>
